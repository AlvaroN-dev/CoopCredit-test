@startuml CoopCredit - Microservices Architecture

!theme plain
skinparam componentStyle rectangle

title CoopCredit - Microservices Architecture with Observability

' ==================== CLIENTE ====================
actor "Client\n(App/Browser)" as Client #LightBlue
actor "DevOps Engineer" as DevOps #Orange

' ==================== CAPA EDGE ====================
package "Edge Layer" as EdgeLayer #AliceBlue {
    component [API Gateway\n:8080] as Gateway #CornflowerBlue
}

' ==================== SERVICIOS DE INFRAESTRUCTURA ====================
package "Infrastructure Services" as InfraServices #LightGray {
    component [Config Server\n:8888] as ConfigServer #DarkKhaki
    component [Eureka Server\n:8761] as EurekaServer #MediumPurple
}

' ==================== MICROSERVICIOS DE NEGOCIO ====================
package "Business Microservices" as BusinessServices #Honeydew {
    component [Credit Service\n:8082] as CreditService #LightSeaGreen
    note right of CreditService
        **Actuator Endpoints:**
        /actuator/health
        /actuator/metrics
        /actuator/prometheus
        
        **Custom Metrics:**
        - HTTP Request Tracking
        - Authentication Events
        - JWT Token Validation
    end note
    
    component [Risk Service\n:8083] as RiskService #DarkSeaGreen
    note right of RiskService
        **Features:**
        - Risk Assessment
        - Credit Scoring
        - Actuator Enabled
    end note
}

' ==================== CAPA DE DATOS ====================
package "Data Layer" as DataLayer #LavenderBlush {
    database "PostgreSQL\n:5433" as DbCredit #SteelBlue
    note right of DbCredit
        **Database:** credit_db
        **Tables:**
        - users, roles, user_roles
        - affiliates
        - credit_applications
        - risk_evaluations
    end note
}

' ==================== OBSERVABILIDAD ====================
package "Observability Stack" as Observability #LemonChiffon {
    component [Prometheus\n:9090] as Prometheus #Orange
    note right of Prometheus
        **Scraping Config:**
        - Interval: 5 seconds
        - Path: /actuator/prometheus
        
        **Access:**
        http://localhost:9090
        http://localhost:9090/targets
    end note
    
    component [Grafana\n:3000] as Grafana #OrangeRed
    note right of Grafana
        **Access:**
        http://localhost:3000
        admin / admin
        
        **Dashboards:**
        - ID 12900: Spring Boot APM
        - ID 4701: JVM Micrometer
        - ID 10280: Spring Boot Stats
    end note
}

' ==================== CONEXIONES PRINCIPALES ====================
Client --> Gateway : "HTTP/REST Requests"

Gateway --> CreditService : "Route /api/credit/**\nRoute /api/auth/**"
Gateway --> RiskService : "Route /api/risk/**"

' ==================== CONEXIONES DE DATOS ====================
CreditService --> DbCredit : "JDBC Connection"
RiskService ..> DbCredit : "Read-only Access"

' ==================== COMUNICACIÓN INTER-SERVICIOS ====================
CreditService --> RiskService : "Synchronous Risk\nEvaluation API"

' ==================== REGISTRO EN EUREKA ====================
CreditService ..> EurekaServer : "Service Registration"
RiskService ..> EurekaServer : "Service Registration"
Gateway ..> EurekaServer : "Service Discovery"

' ==================== CONFIGURACIÓN CENTRALIZADA ====================
CreditService ..> ConfigServer : "Fetch Configuration"
RiskService ..> ConfigServer : "Fetch Configuration"
Gateway ..> ConfigServer : "Fetch Configuration"

' ==================== MÉTRICAS Y MONITOREO ====================
Prometheus --> Gateway : "Scrape /actuator/prometheus\n(every 5s)"
Prometheus --> CreditService : "Scrape /actuator/prometheus\n(every 5s)"
Prometheus --> RiskService : "Scrape /actuator/prometheus\n(every 5s)"

Grafana --> Prometheus : "PromQL Queries"
DevOps --> Grafana : "View Dashboards"
DevOps --> Prometheus : "Query Metrics"

' ==================== LEYENDA ====================
legend right
  |= Color |= Component Type |
  | <#CornflowerBlue> | API Gateway |
  | <#LightSeaGreen> | Credit Service (Auth + Business) |
  | <#DarkSeaGreen> | Risk Assessment Service |
  | <#MediumPurple> | Service Discovery (Eureka) |
  | <#DarkKhaki> | Configuration Server |
  | <#SteelBlue> | PostgreSQL Database |
  | <#Orange> | Prometheus Monitoring |
  | <#OrangeRed> | Grafana Visualization |
endlegend

@enduml
